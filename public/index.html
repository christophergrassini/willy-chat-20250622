<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Chatta con Fiorella</title>
<style>
/* ---------- layout generale ---------- */
:root  {
  --bg:#ffffff;            /* sfondo globale */
  --panel:#ffffff;         /* box centrale */
  --border:#e3e3e7;
  --user:#d2e4ff;          /* bolla utente */
  --bot:#e9e9eb;           /* bolla bot   */
  --green:#00000014;
  font-family: ui-sans-serif, system-ui, sans-serif;
}
html,body{height:100%;margin:0;background:var(--bg);}
.container{
  max-width:720px;margin:0 auto;height:100%;
  display:flex;flex-direction:column;
}
h1{margin:24px 0;text-align:center;font-size:26px;color:#202123}
/* ---------- chat area ---------- */
.chat-box{
  flex:1;border:1px solid var(--border);border-radius:8px;
  padding:24px 32px;background:var(--panel);
  overflow-y:auto;scroll-behavior:smooth;
}
.chat-box::-webkit-scrollbar{width:8px}
.chat-box::-webkit-scrollbar-thumb{background:#c8c8cb;border-radius:4px}
/* ---------- messaggi ---------- */
.message{max-width:100%;padding:14px 18px;border-radius:8px;line-height:1.55;white-space:pre-wrap}
.message.user{background:var(--user);align-self:flex-end}
.message.bot {background:var(--bot);align-self:flex-start}
.message + .message{margin-top:16px}
/* markdown base */
.message h3{margin:6px 0;font-size:16px}
.message ul{margin:6px 0 6px 18px;padding:0}
.message li{margin:4px 0}
/* ---------- form ---------- */
form{display:flex;gap:12px;margin:20px 0}
textarea{
  flex:1;resize:none;padding:12px;border:1px solid var(--border);
  border-radius:8px;font-size:16px;height:56px;background:#fff;
}
button{
  background:var(--green);color:#fff;border:none;border-radius:8px;
  padding:0 22px;font-size:16px;cursor:pointer
}
button:hover{background:#0e8a6b}
</style>
</head>
<body>
  <div class="container">
    <h1>Chatta con Fiorella</h1>

    <div id="chat" class="chat-box"></div>

    <form id="message-form" autocomplete="off">
      <textarea id="input" placeholder="Quale corso cerchi? Come posso aiutarti?"></textarea>
      <button type="submit">Invia</button>
    </form>
  </div>

<script>
const chat   = document.getElementById("chat");
const input  = document.getElementById("input");
const form   = document.getElementById("message-form");
const thread = [];

function add(role, html){
  const div = document.createElement("div");
  div.className = `message ${role}`;
  div.innerHTML  = html;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}
function mdEscape(str){
  return str.replace(/&/g,"&amp;").replace(/</g,"&lt;")
            .replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>")
            .replace(/^\s*### (.+)$/gm,"<h3>$1</h3>")
            .replace(/^\s*-\s(.+)$/gm,"<ul><li>$1</li></ul>");
}

form.addEventListener("submit", async e=>{
  e.preventDefault();
  const text = input.value.trim();
  if(!text) return;
  add("user",mdEscape(text));
  thread.push({role:"user",content:text});
  input.value="";

  const res    = await fetch("/api/chat",{method:"POST",headers:{ "Content-Type":"application/json"},body:JSON.stringify({thread})});
  const reader = res.body.getReader();
  const dec    = new TextDecoder();
  let assistant="", botDiv=add("bot","");

  while(true){
    const {done,value}=await reader.read();
    if(done) break;
    assistant += dec.decode(value)
      .split("\n")
      .filter(l=>l.startsWith("data: "))
      .map(l=>{
        try{return JSON.parse(l.slice(6)).choices[0]?.delta?.content||""}
        catch{return""}
      })
      .join("");
    botDiv.innerHTML = mdEscape(assistant);
  }
  thread.push({role:"assistant",content:assistant});
});
</script>
</body>
</html>
