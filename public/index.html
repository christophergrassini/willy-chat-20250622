<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Chatta con Fiorella</title>
<style>
/* ---------- layout generale ---------- */
:root {
  --bg: #fff;
  --panel: #fff;
  --border: #e3e3e7;
  --user: #e9e9eb;
  --bot: #f7f7f8;
  --green: #10a37f;
  font-family: 'Inter', ui-sans-serif, system-ui, sans-serif;
}

html, body {
  height: 100%;
  margin: 0;
  background: var(--bg);
}

.container {
  max-width: 900px;
  margin: 0 auto;
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h1 {
  margin: 40px 0 12px 0;
  text-align: center;
  font-size: 28px;
  color: #202123;
  font-weight: 600;
  letter-spacing: -0.5px;
}

.chat-box {
  flex: 1;
  width: 100%;
  max-width: 540px;
  border: none;
  border-radius: 0;
  padding: 0;
  background: var(--panel);
  overflow-y: auto;
  scroll-behavior: smooth;
  margin-top: 24px;
  margin-bottom: 12px;
  box-shadow: none;
}

.message {
  max-width: 80%;
  padding: 14px 20px;
  border-radius: 16px;
  line-height: 1.6;
  white-space: pre-wrap;
  font-size: 16px;
  margin-bottom: 10px;
  box-shadow: 0 1px 2px rgba(60,60,60,0.04);
}

.message.user {
  background: var(--user);
  align-self: flex-end;
  color: #222;
}

.message.bot {
  background: var(--bot);
  align-self: flex-start;
  color: #222;
}

.message + .message {
  margin-top: 0;
}

form {
  display: flex;
  gap: 10px;
  margin: 0 0 32px 0;
  width: 100%;
  max-width: 540px;
}

textarea {
  flex: 1;
  resize: none;
  padding: 16px 16px;
  border: 1px solid var(--border);
  border-radius: 14px;
  font-size: 16px;
  background: #f7f7f8;
  color: #222;
  min-height: 48px;
  outline: none;
  box-shadow: none;
  transition: border 0.2s;
}

textarea:focus {
  border: 1.5px solid #10a37f;
}

button {
  background: var(--green);
  color: #fff;
  border: none;
  border-radius: 14px;
  padding: 0 24px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
  min-width: 80px;
  min-height: 48px;
}

button:hover {
  background: #0e8a6b;
}

.chat-box::-webkit-scrollbar {
  width: 8px;
  background: transparent;
}

.chat-box::-webkit-scrollbar-thumb {
  background: #f0f0f2;
  border-radius: 4px;
}
</style>
</head>
<body>
  <div class="container">
    <h1>Chatta con Fiorella</h1>

    <div id="chat" class="chat-box"></div>

    <form id="message-form" autocomplete="off">
      <textarea id="input" placeholder="Quale corso cerchi? Come posso aiutarti?"></textarea>
      <button type="submit">Invia</button>
    </form>
  </div>

<script>
const chat   = document.getElementById("chat");
const input  = document.getElementById("input");
const form   = document.getElementById("message-form");
const thread = [];

function add(role, html){
  const div = document.createElement("div");
  div.className = `message ${role}`;
  div.innerHTML  = html;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}
function mdEscape(str){
  return str.replace(/&/g,"&amp;").replace(/</g,"&lt;")
            .replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>")
            .replace(/^\s*### (.+)$/gm,"<h3>$1</h3>")
            .replace(/^\s*-\s(.+)$/gm,"<ul><li>$1</li></ul>");
}

form.addEventListener("submit", async e=>{
  e.preventDefault();
  const text = input.value.trim();
  if(!text) return;
  add("user",mdEscape(text));
  thread.push({role:"user",content:text});
  input.value="";

  const res    = await fetch("/api/chat",{method:"POST",headers:{ "Content-Type":"application/json"},body:JSON.stringify({thread})});
  const reader = res.body.getReader();
  const dec    = new TextDecoder();
  let assistant="", botDiv=add("bot","");

  while(true){
    const {done,value}=await reader.read();
    if(done) break;
    assistant += dec.decode(value)
      .split("\n")
      .filter(l=>l.startsWith("data: "))
      .map(l=>{
        try{return JSON.parse(l.slice(6)).choices[0]?.delta?.content||""}
        catch{return""}
      })
      .join("");
    botDiv.innerHTML = mdEscape(assistant);
  }
  thread.push({role:"assistant",content:assistant});
});
</script>
</body>
</html>
